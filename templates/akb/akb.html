{% extends "base.html" %}
{% block title %}Аккумуляторы{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <!-- SIDEBAR: фильтры -->
    <div class="col-lg-3 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <form method="get" id="filter-form">
            <h6 class="fw-semibold mb-3 border-bottom pb-2">Ёмкость (Ah)</h6>
            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="form-label small mb-1">От</label>
                {{ filter.form.min_container }}
              </div>
              <div class="col-6">
                <label class="form-label small mb-1">До</label>
                {{ filter.form.max_container }}
              </div>
            </div>

            <h6 class="fw-semibold mb-3 border-bottom pb-2">Пусковой ток (A)</h6>
            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="form-label small mb-1">От</label>
                {{ filter.form.min_start_current }}
              </div>
              <div class="col-6">
                <label class="form-label small mb-1">До</label>
                {{ filter.form.max_start_current }}
              </div>
            </div>

            <h6 class="fw-semibold mb-3 border-bottom pb-2">Полярность</h6>
            <div class="mb-3">
              {% for choice in filter.form.polarity.field.choices %}
                {% with sel=filter.form.polarity.value %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="polarity" value="{{ choice.0 }}" id="pol_{{ forloop.counter }}"
                    {% if sel and choice.0 in sel %}checked{% endif %}>
                  <label class="form-check-label" for="pol_{{ forloop.counter }}">{{ choice.1 }}</label>
                </div>
                {% endwith %}
              {% endfor %}
            </div>

            <div class="accordion mb-3" id="accordionFilters">
              <!-- Производитель -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingBrand">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBrand" aria-expanded="false">
                    Производитель
                  </button>
                </h2>
                <div id="collapseBrand" class="accordion-collapse collapse">
                  <div class="accordion-body">
                    <input type="text" class="form-control form-control-sm mb-2" id="searchBrand" placeholder="Поиск">
                    <div class="brand-list" style="max-height: 220px; overflow-y: auto;">
                      {% for choice in filter.form.brand.field.choices %}
                        {% with sel=filter.form.brand.value %}
                        <div class="form-check brand-item">
                          <input class="form-check-input" type="checkbox" name="brand" value="{{ choice.0 }}" id="brand_{{ forloop.counter }}"
                            {% if sel and choice.0 in sel %}checked{% endif %}>
                          <label class="form-check-label small" for="brand_{{ forloop.counter }}">{{ choice.1 }}</label>
                        </div>
                        {% endwith %}
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Модель -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingModel">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseModel">
                    Модель
                  </button>
                </h2>
                <div id="collapseModel" class="accordion-collapse collapse">
                  <div class="accordion-body">
                    <input type="text" class="form-control form-control-sm mb-2" id="searchModel" placeholder="Поиск">
                    <div class="model-list" style="max-height: 220px; overflow-y: auto;">
                      {% for choice in filter.form.model.field.choices %}
                        {% with sel=filter.form.model.value %}
                        <div class="form-check model-item">
                          <input class="form-check-input" type="checkbox" name="model" value="{{ choice.0 }}" id="model_{{ forloop.counter }}"
                            {% if sel and choice.0 in sel %}checked{% endif %}>
                          <label class="form-check-label small" for="model_{{ forloop.counter }}">{{ choice.1 }}</label>
                        </div>
                        {% endwith %}
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary">Показать</button>
              <a href="{% url 'akb:akb' %}" class="btn btn-outline-secondary">Сбросить</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- СПИСОК АКБ -->
    <div class="col-lg-9">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Найдено аккумуляторов: {{ filter.qs.count }}</h5>
        {% if request.GET %}
          <a href="{% url 'akb:akb' %}" class="btn btn-sm btn-outline-secondary">Сбросить фильтры</a>
        {% endif %}
      </div>

      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
        {% for akb in akbs %}
        <div class="col d-flex align-items-stretch">
          <div class="card h-100 shadow-sm d-flex flex-column">

            {# ✅ Исправленный вывод изображения #}
            {% with raw=akb.image_url|default_if_none:'' %}
              <img
                src="{% if '://' in raw %}{{ raw }}{% else %}https://{% if raw|slice:':1' == '/' %}{{ raw|slice:'1:' }}{% else %}{{ raw }}{% endif %}{% endif %}"
                class="card-img-top"
                alt="{{ akb.name }}"
                style="object-fit: contain; height: 180px;"
                loading="lazy"
              >
            {% endwith %}

            <div class="card-body d-flex flex-column">
              <h6 class="card-title" style="line-height: 1.2;">{{ akb.name }}</h6>
              <div class="small text-muted mb-2">
                <div><strong>Артикул:</strong> {{ akb.art }}</div>
                <div><strong>Бренд:</strong> {{ akb.brand }}</div>
                <div><strong>Модель:</strong> {{ akb.model }}</div>
                <div><strong>Ёмкость:</strong> {{ akb.container }} Ah</div>
                <div><strong>Пусковой ток:</strong> {{ akb.start_current }} A</div>
                <div><strong>Полярность:</strong> {{ akb.polarity }}</div>
                <div><strong>Габариты:</strong> {{ akb.length }}×{{ akb.width }}×{{ akb.height }} мм</div>
              </div>

              <div class="fw-bold text-primary mb-2">{{ akb.price }} ₽</div>
              <div class="small text-success mb-3">В наличии: {{ akb.count }} шт.</div>

              <div class="mt-auto d-flex gap-2">
                <a href="#" class="btn btn-sm btn-primary flex-fill">В корзину</a>
                <a href="#" class="btn btn-sm btn-outline-secondary flex-fill">Наличие</a>
                <a href="#" class="btn btn-outline-danger btn-sm"><i class="bi bi-heart"></i></a>
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
          <h4 class="text-muted mt-3">Аккумуляторы не найдены</h4>
          <p class="text-muted">Попробуйте изменить параметры фильтра</p>
          <a href="{% url 'akb:akb' %}" class="btn btn-primary">Сбросить фильтры</a>
        </div>
        {% endfor %}
      </div>

      {% if akbs.has_other_pages %}
      <div class="mt-4">
        <nav>
          <ul class="pagination justify-content-center">
            {% if akbs.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ akbs.previous_page_number }}">&laquo;</a></li>
            {% endif %}
            {% for num in akbs.paginator.page_range %}
              {% if num >= akbs.number|add:-2 and num <= akbs.number|add:2 %}
                <li class="page-item {% if akbs.number == num %}active{% endif %}">
                  <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}
            {% if akbs.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ akbs.next_page_number }}">&raquo;</a></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
function setupAccordionSearch(inputId, itemClass) {
  const input = document.getElementById(inputId);
  if (!input) return;
  input.addEventListener('input', function () {
    const q = this.value.toLowerCase();
    document.querySelectorAll('.' + itemClass).forEach(it => {
      const txt = it.textContent.toLowerCase();
      it.style.display = txt.includes(q) ? 'block' : 'none';
    });
  });
}
document.addEventListener('DOMContentLoaded', function () {
  setupAccordionSearch('searchBrand', 'brand-item');
  setupAccordionSearch('searchModel', 'model-item');
});
</script>

<style>
.brand-list::-webkit-scrollbar, 
.model-list::-webkit-scrollbar { width: 6px; }
.brand-list::-webkit-scrollbar-thumb, 
.model-list::-webkit-scrollbar-thumb { border-radius: 3px; background: #c1c1c1; }
.form-check { margin-bottom: 0.35rem; }
.form-check-label { font-size: 0.9rem; }
</style>
{% endblock %}
